ver = "0.2.8"

##### Compilation Tests ######
## Test each pass in isolation. Gets the pass flags from a comment on the first line of the file
[[tests]]
name = "passes"
paths = [
  "tests/passes/*.futil",
  "tests/passes/resource-sharing/*.futil",
  "tests/passes/minimize-regs/*.futil",
  "tests/passes/compile-control/*.futil",
  "tests/passes/regressions/*.futil"
]
# gets the pass flags a comment on the first line of the test file
cmd = """
flags=$(head -n 1 {} | cut -c 3-)
./target/debug/futil {} $flags
"""

[[tests]]
name = "parsing"
# Round-tripping from the compiler should not change anything.
paths = [ "./tests/parsing/*.expect" ]
cmd = """
./target/debug/futil {} -p none
"""

## Tests the error messages generated by the compiler. Runs passes for error
## checking.
[[tests]]
name = "errors"
paths = [
  "tests/errors/*.futil",
  "tests/errors/parser/*.futil"
]
cmd = """
./target/debug/futil {} -p well-formed -p papercut
"""

##### Correctness Tests #####
## Tests that ensure that individual control constructs have correct
## behavior when compiled.
[[tests]]
name = "correctness dynamic"
paths = [ "tests/correctness/*.futil" ]
cmd = """
fud exec -s verilog.data {}.data \
         -s futil.flags '-d static-timing' \
         -s futil.exec './target/debug/futil' \
         -s verilog.cycle_limit 500 \
         {} --to dat \
         -q
"""

## Same as correctness dynamic but runes with static-timing
[[tests]]
name = "correctness static timing"
paths = [ "tests/correctness/*.futil" ]
cmd = """
fud exec -s verilog.cycle_limit 500 \
         -s verilog.data {}.data \
         -s futil.exec './target/debug/futil' \
         {} --to dat \
         -q
"""

[[tests]]
name = "systolic array correctness"
paths = [ "tests/correctness/systolic/*.txt" ]
cmd = """
fud e --from systolic --to vcd_json \
      -s systolic.flags "$(cat {})" \
      -s verilog.data {}.data \
      -s futil.exec './target/debug/futil' \
      -q \
      | jq -f {}.jq

"""

[[tests]]
name = "NTT correctness"
paths = [ "ntt/cooley-tukey/*.fuse", "ntt/naive/*.fuse" ]
expect_dir = "ntt/expected"
cmd = """
fud e {} --to dat -s verilog.data ntt/ntt.data -q
"""

[[tests]]
name = "mrxl correctness"
paths = [ "frontends/mrxl/test/*.mrxl" ]
cmd = """
fud e -q {} --from mrxl --to dat -s verilog.data {}.data
"""

##### Backend Tests #####
[[tests]]
name = "verilog backend"
paths = [ "tests/backend/verilog/*.futil" ]
cmd = """
fud exec {} --to verilog -q \
            -s futil.exec './target/debug/futil'
"""


##### Frontend Tests #####
[[tests]]
name = "dahlia frontend"
paths = [ "tests/frontend/dahlia/*.fuse" ]
cmd = """
fud e {} --to futil -q \
          -s futil.exec './target/debug/futil' \
        | tail -n+2
"""

[[tests]]
name = "systolic array frontend"
paths = [ "tests/frontend/systolic/array-*.txt" ]
cmd = """
./frontends/systolic-lang/gen-systolic.py $(cat {})
"""
