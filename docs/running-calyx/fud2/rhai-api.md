# Rhai API

## High Level Rhai

### defop

```
defop <op name>(<input1>: <input1 state>, <input2>: <input2 state> ...) >> <target1>: <target1 state>, <target2>, <target2 state> ... {
    <statements>
}
```
Defines an op with `<op name>` which runs `<statements>` to generate target states from input states. 

The name, inputs, and targets are called the signature of the op. `<statements>` is called the body of the op.

### shell

```
shell(<string>)
```
When called in the body of an op, that op will run `<string>` as a shell command to generate its targets. It is an error to call `shell` outside of the body of an op. Additionally, it is an error to call `shell` in the body of an op in which `shell_deps` was called prior.

In the generated Ninja code, `shell` will create both a `rule` wrapping the shell command and a `build` command that invokes that rule. When a `defop` contains multiple `shell` commands, `fud2` automatically generates Ninja dependencies among the `build` command to ensure they run in order.

### shell_deps

```
shell_deps(<string>, [<dep1>, <dep2>, ...], [<target1>, <target2>, ..])
```
When called in the body of an op, that op will run `<string>` as a shell command if it needs to generate `<target1>, <target2>, ...` from `<dep1>, <dep2>, ...`. It is an error to call `shell_deps` outside of the body of an op. Additionally, it is an error to call `shell_deps` in the body of an op in which `shell`  was called prior.

Targets and deps are either strings, such as `"file1"`, or identifiers, such as if `c: calyx` existed in the signature of an op then `c` could be used as a target or dep.

A call to `shell_deps` corresponds directly to a Ninja rule in the Ninja file generated by `fud2`.

## Low Level Rhai

A common routine for using low level Rhai is:
1. Define states
2. Define setup functions that register variables and rules
3. Define an emitter function that produces commands using variables and rules created from (2)
4. Define an op that uses setup functions and emitter to produce the target state from the start state

### Defining states

```
state(<name>, [<ext1>, <ext2>, .. ])
```
Defines a state with the name `<name>` where files can have extensions `<ext1>`, `<ext2>`, etc. `<name>` and extensions are all strings.

### Defining operations

```
op(<op name>, [<setup1>, <setup2>, ..], <input state>, <output state>, <emit function>)
```

Defines an op with name `<op name>` that generates `<output state>` from `<input state>`. `<op name>` is a string, and `<input state>` and `<output state>` are states. 

The op uses the setup functions `<setup1>, <setup2>, ..` to create vars and rules, and the `<emit function>` to produce commands.

A setup function is simply a function that takes in an emitter.

The emit function would have the following declaration:
```
|e, input, output| { ... }
```
where `e` is an emitter, and `input` and `output` are strings containing the filenames of the input and output of the operation.

### Emitter API

#### Creating variables

```
var_(<variable name>, <filename>)
```
Defines a Ninja variable `<variable name>` which refers to the file `<filename>`. Both `<variable name>` and `<filename>` are strings.

<br>

```
config_var(<variable name>, <configuration path>)
```
Defines a Ninja variable `<variable name>` using the value obtained from `<configuration path>` from the configuration file. Both `<variable name>` and `<configuration path>` are strings.

<br>

```
config_var_or(<variable name>, <configuration path>, <default>)
```
Defines a Ninja variable `<variable name>` using the value obtained from `<configuration path>` from the configuration file if the value exists, or `<default>` otherwise. Both `<variable name>` and `<configuration path>` are strings.

<br>

```
config_val(<config var>)
```
Returns the value of the configuration variable `<config var>` with the value provided. Panics if the configuration variable does not have a value.

<br>

```
config_constrained_or(<config var>, [<valid val1>, <valid val2>, ..], <default>)
```
Returns the value of the configuration variable `<config var>` if the value provided is valid, i.e. contained within `[<valid val1>, <valid val2>, ..]`. Panics if the value is not valid.

If configuration variable `<config var>` was not provided, then `<default>` will be returned.

`<config var>`, all `<valid val>`s, and `<default>` are all strings.

<br>

```
external_path(<path>)
```
Returns a `Utf8PathBuf` to an external file described by `<path>`. The input `path` may be relative to our original invocation; we make it relative to the build directory so it can safely be used in the Ninja file.


#### Defining rules

```
rule(<rule name>, <shell command>)
```
Registers a shell command `<shell command>` under the Ninja rule name `<rule name>`. Both `<rule name>` and `<shell command>` are strings.

#### Building commands

```
build_cmd([<target>], <rule>, [<dep1>, <dep2>, ..], [<implicit_dep1>, <implicit_dep2>, ..])
```
Emits a Ninja build command that generates the build target `<target>` with the rule `<rule>` by using `<dep1>, ..` and `<implicit_dep1>, ..`.

`<target>` replaces `$out` in `<rule>`, and `<dep1>, <dep2>, ..` replace `$in` in `<rule>`. `<implicit_dep1>, ..` should be strings containing variable names defined previously defined via setups referred as `$<var name>`.

<br>

```
arg(<arg name>, <value>)
```
Adds the argument `<arg name>` to the preceding rule or build command with the value `<value>`.

### Adding to the API

If there is something that is hard to do in Rhai, it is straightforward to [register a Rust function][rhai-rust-fn] so that it is available from Rhai.

Rust functions are registered in [`ScriptRunner::new`][fud-core-scriptrunner]. Refer to [`ScriptRunner::reg_get_state`][fud-core-reg_get_state] to see a simple example of how to register a function.

[rhai]: https://rhai.rs/book/index.html
[rhai-strings]: https://rhai.rs/book/ref/string-fn.html?highlight=String#standard-string-functions
[rhai-rust-fn]: https://rhai.rs/book/rust/functions.html
[fud2-scripts]: https://github.com/calyxir/calyx/tree/main/fud2/scripts
[fud-core-scriptrunner]: https://github.com/calyxir/calyx/blob/6f895a1353020ce254860c3aa0fcfa2ba1abf4c4/fud2/fud-core/src/script/plugin.rs#L68
[fud-core-reg_get_state]: https://github.com/calyxir/calyx/blob/6f895a1353020ce254860c3aa0fcfa2ba1abf4c4/fud2/fud-core/src/script/plugin.rs#L152
