# FUD: The FuTIL Driver

Working with FuTIL involves a lot of command-line tools. For example, an
incomplete yet daunting list of CLI tools used by FuTIL is:

- The Dahlia & the systolic array compilers
- FuTIL compiler and its various command line tools
- Verilator, the Verilog simulation framework used to test FuTIL-generated designs.
- Waveform viewers to see the results of simulation

`fud` aims to provide a simple interface for using these toolchains and
executing them in a pipeline. The source for fud is
[here](https://github.com/cucapra/futil/tree/master/fud).

## Installation
You need [Flit](https://flit.readthedocs.io/en/latest/) to install `fud`. Install it with `pip3 install flit`.

You can then install `fud` with

```bash
flit install
```
(If using this method to install `fud`, `pip3` should be version >= 20)

You can also install `fud` with

```bash
flit build
pip3 install dist/fud-0.1.0-py3-none-any.whl
```

If you are working on `fud` itself, you can install it with a symlink with:
```bash
flit install --symlink
```

### Configuration

Fud uses a global configuration file to locate tool paths and default values.
To view the configuration, use `fud config`.

**Viewing keys.**
To view the current value of a key, use `fud config key`. For example, the
following shows the path to the FuTIL compiler.
```bash
fud config stages.futil.exec
```

**Updating keys.**
Keys can be updated using `fud config key value`.
For example, the following command updates the path to the FuTIL compiler.
```bash
fud config stages.futil.exec ./target/debug/futil
```

**Dahlia.**
In order to use the Dahlia frontend with Fud, first
[install Dahlia](https://github.com/cucapra/dahlia).
Once Dahlia is compiled, you need to configure `fud` so that it knows where to
find the binary.
In the Dahlia directory run:
```bash
fud config dahlia.stages.exec `pwd`/fuse
```

**Verilator.**
We use the open source [Verilator](https://www.veripool.org/wiki/verilator) tool to simulate
Verilog programs generated by the FuTIL compiler.
Installation instructions are here:
[Install Verilator](https://www.veripool.org/projects/verilator/wiki/Installing)

**Vcdump.**
Vcdump is a tool for converting `vcd` (Value Change Dump) files to json for easier analysis with the command line.
Install it with:
```bash
cargo install vcdump
```

**Check.**
Fud can automatically check if your configuration is valid and can help you set
certain variables. Perform this check with:
```bash
fud check
```


## Usage
These commands will assume you're in the root directory of the FuTIL
repository.

**Compiling FuTIL.**
Fud wraps the FuTIL compiler and provides a set of default compiler options
to compile FuTIL programs to Verilog.

```bash
# Compile FuTIL source in the test vectorized-add.expect
# to Verilog. We must explicitly specify the input
# file type because it can not be guessed from
# the extension.
fud exec examples/tests/vectorized-add.expect --from futil --to verilog
```

Fud can explain its execution plan when running a complex sequence of
steps using the `--dry-run` option.
```bash
# Dry run of compiling the Dahlia dot product file
# to FuTIL. As expected, this will *only* print
# the stages that will be run.
fud exec examples/dahlia/dot-product.fuse --to futil --dry-run
```

**Simulating FuTIL.**
Fud can compile a FuTIL program to Verilog and simulate it using Verilator.


```bash
# Compile and simulate a vectorized add implementation
# in FuTIL using the data provided,
# then dump the vcd into a new file for debugging.
# === FuTIL:   examples/futil/vectorized-add.futil
# === data:    examples/data/vectorized-add.data
# === output:  v-add.vcd
fud exec \
  examples/futil/vectorized-add.futil \
  -o v-add.vcd \
  -s verilog.data examples/data/vectorized-add.data
```

**Simulating Dahlia.**
The following command prints out the final state of all memories by specifying
`--to dat`.

```bash
# Compile a Dahlia dot product implementation and
# simulate in verilog using the data provided.
# === Dahlia: examples/dahlia/dot-product.fuse
# === data:   examples/data/dot-product.data
#     (`.data` is used as an extension alias for `.json`)
fud exec \
  examples/dahlia/dot-product.fuse \
  --to dat \
  -s verilog.data examples/data/dot-product.data
```

### Working with Stages

Fud is structured as a sequence of stages that transform inputs of one form
to outputs.

**Stages.**
`fud` transforms a file in one stage into a file in a later stage.
The `--from` and `--to` options specify the input and output stages to the
`fud exec` subcommand.
Use `fud info` to view all possible stages.

**Guessing stages.**
`fud` will try to guess the starting stage by looking at the extension of the
input file and output file (if specified using the `-o` flag).
If it fails to guess correctly or doesn't know about the extension, you can
manually set the stages using `--to` and `--from`.
