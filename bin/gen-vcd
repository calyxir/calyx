#!/bin/sh

set -eux

filename="$1"
stem="${filename%.*}"

# Create a temporary folder to store objects generated from verilator.
tmp="$(mktemp -d)"
cp sim/testbench.cpp "$tmp"/

# Generate required objects for verilator run.
verilator -cc --trace "$filename" \
  --exe testbench.cpp --top-module main --Mdir "$tmp"

# Generate and execute verilator C harness.
make -j -C "$tmp" -f Vmain.mk Vmain
"$tmp"/Vmain "$stem".vcd

# Clean up temporary folder.
rm -rf "$tmp"
